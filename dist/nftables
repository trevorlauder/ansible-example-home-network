#
# Ansible managed
#

# =========================================
# Table Definitions
# =========================================

# Create main tables for NAT and filtering
add table inet nat
add table inet filter

# =========================================
# Chain Definitions
# =========================================

# NAT table chains for address translation
add chain inet nat PREROUTING { type nat hook prerouting priority -100; policy accept; }
add chain inet nat POSTROUTING { type nat hook postrouting priority 100; policy accept; }

# Filter table chains for main firewall logic
add chain inet filter INPUT { type filter hook input priority 0; policy drop; }
add chain inet filter FORWARD { type filter hook forward priority 0; policy drop; }
add chain inet filter OUTPUT { type filter hook output priority 0; policy accept; }

# Custom chains for policy drops and logging
add chain inet filter INPUT_LOG_DROP
add chain inet filter FORWARD_LOG_DROP

# Generic counters for tracking rule hits
add counter inet filter forward_antispoof_ipv4_drop
add counter inet filter forward_antispoof_ipv6_drop
add counter inet filter forward_established
add counter inet filter forward_invalid_state_drop
add counter inet filter forward_ipv4_drop
add counter inet filter forward_ipv6_drop
add counter inet filter forward_log_drop
add counter inet filter forward_policy_jump_log_drop
add counter inet filter input_antispoof_ipv4_drop
add counter inet filter input_antispoof_ipv6_drop
add counter inet filter input_established
add counter inet filter input_icmp_rate_limit_ipv4
add counter inet filter input_icmp_rate_limit_ipv6
add counter inet filter input_icmpv6_wan
add counter inet filter input_invalid_state_drop
add counter inet filter input_lo
add counter inet filter input_log_drop
add counter inet filter input_policy_jump_log_drop

# =====================
# PREROUTING
# =====================

# Redirect DNS queries to local gateway for each subnet that requires it

# DNS PREROUTING - dmz.example.local
add rule inet nat PREROUTING iifname eth2 meta l4proto { tcp, udp } th dport 53 counter dnat ip to 192.168.2.1:53

# DNS PREROUTING - home.example.local
add rule inet nat PREROUTING iifname eth1 meta l4proto { tcp, udp } th dport 53 counter dnat ip to 192.168.1.1:53

# =========================================
# Sets and Counters
# =========================================

# Sets for grouping addresses to drop in FORWARD chain
add set inet filter IPV4_FORWARD_DROP { type ipv4_addr; flags interval; }
add set inet filter IPV6_FORWARD_DROP { type ipv6_addr; flags interval; }

# Sets for private IPv4 ranges to drop in INPUT and FORWARD chains
add set inet filter private_ipv4 { type ipv4_addr; flags interval; }
add element inet filter private_ipv4 { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 }

# Sets for private IPv6 ranges to drop in INPUT and FORWARD chains
add set inet filter private_ipv6 { type ipv6_addr; flags interval; }
add element inet filter private_ipv6 { fc00::/7 }

# =========================================
# NAT: IPv4 Masquerade
# =========================================

# Masquerade all outgoing IPv4 traffic on the WAN interface
add rule inet nat POSTROUTING oifname eth0 ip version 4 counter masquerade

# =========================================
# INPUT Chain Rules
# =========================================

# Drop invalid connection states
add rule inet filter INPUT ct state invalid counter name input_invalid_state_drop drop comment "Invalid connection state"

# Drop LAN addresses on WAN interface
add rule inet filter INPUT iifname eth0 ip saddr @private_ipv4 counter name input_antispoof_ipv4_drop drop comment "Antispoof IPv4 on WAN"
add rule inet filter INPUT iifname eth0 ip6 saddr @private_ipv6 counter name input_antispoof_ipv6_drop drop comment "Antispoof IPv6 on WAN"

# Rate limit ICMP and ICMPv6 packets
add rule inet filter INPUT ip protocol icmp limit rate 20/second burst 10 packets counter name input_icmp_rate_limit_ipv4 drop comment "ICMP rate limit"
add rule inet filter INPUT meta l4proto icmpv6 limit rate 20/second burst 10 packets counter name input_icmp_rate_limit_ipv6 drop comment "ICMPv6 rate limit"

# Log and drop packets in INPUT_LOG_DROP chain
add rule inet filter INPUT_LOG_DROP limit rate 10/minute burst 5 packets log prefix "INPUT:DROP: " level notice
add rule inet filter INPUT_LOG_DROP counter name input_log_drop drop

# Accept loopback traffic
add rule inet filter INPUT iifname lo counter name input_lo accept

# Accept established and related connections on INPUT chain
add rule inet filter INPUT ct state related,established counter name input_established accept


# =========================================
# Per-Subnet INPUT Rules
# =========================================

### dmz.example.local ###

# ICMP
add counter inet filter input_icmp_dmz_example_local
add rule inet filter INPUT iifname eth2 ip protocol icmp counter name input_icmp_dmz_example_local accept comment "dmz.example.local"

# DNS requests
add rule inet filter INPUT iifname eth2 meta l4proto { tcp, udp } th dport 53 counter accept comment "dmz.example.local"

# DHCP requests
add rule inet filter INPUT iifname eth2 udp dport 67 counter accept comment "dmz.example.local"

### home.example.local ###

# ICMP
add counter inet filter input_icmp_home_example_local
add rule inet filter INPUT iifname eth1 ip protocol icmp counter name input_icmp_home_example_local accept comment "home.example.local"

# ICMPv6
add counter inet filter input_icmpv6_home_example_local
add rule inet filter INPUT iifname eth1 meta l4proto icmpv6 counter name input_icmpv6_home_example_local accept comment "home.example.local"

# DNS requests
add rule inet filter INPUT iifname eth1 meta l4proto { tcp, udp } th dport 53 counter accept comment "home.example.local"

# DHCP requests
add rule inet filter INPUT iifname eth1 udp dport 67 counter accept comment "home.example.local"
# SSH access to firewall from this subnet interface

add counter inet filter input_ssh_home_example_local_rate_drop
add rule inet filter INPUT iifname eth1 tcp dport 22 ct state new limit rate 10/minute burst 4 packets counter name input_ssh_home_example_local_rate_drop drop comment "home.example.local"

add rule inet filter INPUT iifname eth1 tcp dport 22 counter accept comment "home.example.local"

# =========================================
# INPUT Policy Chain Jump
# =========================================

# Send packets to INPUT_LOG_DROP
add rule inet filter INPUT counter name input_policy_jump_log_drop jump INPUT_LOG_DROP

# =========================================
# FORWARD Chain Rules
# =========================================

# Drop invalid connection states
add rule inet filter FORWARD ct state invalid counter name forward_invalid_state_drop drop comment "Invalid connection state"

# Drop LAN addresses on WAN interface
add rule inet filter FORWARD iifname eth0 ip saddr @private_ipv4 counter name forward_antispoof_ipv4_drop drop comment "Antispoof IPv4 on WAN"
add rule inet filter FORWARD iifname eth0 ip6 saddr @private_ipv6 counter name forward_antispoof_ipv6_drop drop comment "Antispoof IPv6 on WAN"

# Log and drop packets in FORWARD_LOG_DROP chain
add rule inet filter FORWARD_LOG_DROP limit rate 10/minute burst 5 packets log prefix "FORWARD:DROP: " level notice
add rule inet filter FORWARD_LOG_DROP counter name forward_log_drop drop

# Send specific IPs to FORWARD_LOG_DROP chain
add rule inet filter FORWARD oifname eth0 ip daddr @IPV4_FORWARD_DROP counter name forward_ipv4_drop jump FORWARD_LOG_DROP comment "Drop to IPv4 blocklist"
add rule inet filter FORWARD oifname eth0 ip6 daddr @IPV6_FORWARD_DROP counter name forward_ipv6_drop jump FORWARD_LOG_DROP comment "Drop to IPv6 blocklist"

# Drop forwarding to WAN for IP 1.0.0.1
add rule inet filter FORWARD oifname eth0 ip daddr 1.0.0.1 counter jump FORWARD_LOG_DROP comment "1.0.0.1"

# Drop forwarding to WAN for IP 1.1.1.1
add rule inet filter FORWARD oifname eth0 ip daddr 1.1.1.1 counter jump FORWARD_LOG_DROP comment "1.1.1.1"
# Drop forwarding to WAN for IP 2606:4700:4700::1001
add rule inet filter FORWARD oifname eth0 ip6 daddr 2606:4700:4700::1001 counter jump FORWARD_LOG_DROP comment "2606:4700:4700::1001"
# Drop forwarding to WAN for IP 2606:4700:4700::1111
add rule inet filter FORWARD oifname eth0 ip6 daddr 2606:4700:4700::1111 counter jump FORWARD_LOG_DROP comment "2606:4700:4700::1111"

# Accept established and related connections on FORWARD chain
add rule inet filter FORWARD ct state related,established counter name forward_established accept

# =========================================
# Per-Subnet and Per-Device FORWARD Rules
# =========================================

### dmz.example.local ###

# Allow device smoker.cooking.dmz.example.local (eth2) to access WAN (eth0)
add rule inet filter FORWARD iifname eth2 oifname eth0 ether saddr CC:BB:CC:DD:EE:FF counter accept comment "smoker.cooking.dmz.example.local"

### home.example.local ###

# Allow subnet home.example.local (eth1) to access subnet dmz.example.local (eth2)
add rule inet filter FORWARD iifname eth1 oifname eth2 counter accept comment "home.example.local:dmz.example.local"

# Allow device macbookpro.laptop.home.example.local (eth1) to access WAN (eth0)
add rule inet filter FORWARD iifname eth1 oifname eth0 ether saddr AA:BB:CC:DD:EE:FF counter accept comment "macbookpro.laptop.home.example.local"

# =========================================
# FORWARD Policy Chain Jump
# =========================================

# Send packets to FORWARD_LOG_DROP
add rule inet filter FORWARD counter name forward_policy_jump_log_drop jump FORWARD_LOG_DROP
